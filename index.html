<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <title>Final Tiffy Claim</title>
  <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0"></script>
  <script src="https://unpkg.com/web3modal@1.9.12"></script>
  <style>
    body {background:#000;color:#fff;font-family:'Segoe UI';padding:40px;text-align:center;}
    button {padding:15px 40px;font-size:18px;background:gold;border:none;border-radius:12px;cursor:pointer;color:#000;}
    #status {margin-top:20px;color:#0f0;font-size:16px;}
  </style>
</head>
<body>

  <h1>Your Final Claim</h1>
  <button id="claimBtn">üíé CLAIM & GET 10 TIFFY</button>
  <div id="status">Waiting‚Ä¶</div>

  <script>
    const CONTRACT = "0xE488253DD6B4D31431142F1b7601C96f24Fb7dd5";
    const ABI = [
      { "name":"claim","type":"function","stateMutability":"payable","inputs":[] },
      { "name":"lastClaimed","type":"function","stateMutability":"view","inputs":[{"type":"address"}],"outputs":[{"type":"uint256"}]}
    ];
    const BACKEND = "https://tiffyai-wh-wa.onrender.com/reward";

    const providerOptions = {
      walletconnect: {
        package: window.WalletConnectProvider.default,
        options: { rpc:{56:"https://bsc-dataseed.binance.org/"}, chainId:56 }
      }
    };
    const web3Modal = new window.Web3Modal.default({ cacheProvider:false, providerOptions });
    let web3, provider, account, contract;

    async function work() {
      const status = document.getElementById('status');
      try {
        provider = await web3Modal.connect();
        web3 = new Web3(provider);
        const chain = await web3.eth.net.getId();
        if (chain !== 56) throw new Error("‚õî Switch to BNB Mainnet");

        const accs = await web3.eth.getAccounts();
        account = accs[0];
        contract = new web3.eth.Contract(ABI, CONTRACT);

        status.innerText = "Estimating gas‚Ä¶";
        const gas = await contract.methods.claim().estimateGas({from: account, value:0});
        const gasPrice = await web3.eth.getGasPrice();
        const capped = Math.min(parseInt(gasPrice)*1.2, web3.utils.toWei('5','gwei'));

        status.innerText = "Sending claim‚Ä¶";
        await contract.methods.claim().send({ from: account, gas, gasPrice: capped });

        status.innerText = "‚úÖ Claim ok! Requesting 10 TIFFY‚Ä¶";
        const response = await fetch(BACKEND, {
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body: JSON.stringify({ wallet: account, amount:10 })
        });
        const res = await response.json().catch(_=>null);
        if (!response.ok || !res?.success) throw new Error(res?.message || "Backend failed");

        status.innerText = "üéâ Success! Redirecting‚Ä¶";
        setTimeout(()=>window.location.href="/TiffyAI-Users",1500);

      } catch (err) {
        console.error(err);
        const m=err.message||err;
        if (m.includes("insufficient")) {
          status.innerText="‚õΩ Not enough BNB for gas. Please top up.";
        } else {
          status.innerText = "‚ùå " + m;
        }
      }
    }

    document.getElementById('claimBtn').onclick = work;
  </script>
</body>
</html>
